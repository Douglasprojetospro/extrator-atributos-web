{% extends "base.html" %}

{% block title %}Configuração - Extrator de Atributos{% endblock %}

{% block css_adicional %}
<style>
    .config-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    .form-container {
        flex: 1;
        min-width: 400px;
    }
    
    .atributos-container {
        flex: 1;
    }
    
    .atributo-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    
    .atributo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .variacao-item {
        background: #f8f9fa;
        border-left: 3px solid #3498db;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 0 4px 4px 0;
    }
    
    .badge-tipo {
        background-color: #6c757d;
        color: white;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 12px;
    }
    
    .btn-remove {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #dc3545;
        background: none;
        border: none;
        cursor: pointer;
    }
    
    .btn-edit {
        color: #0d6efd;
        background: none;
        border: none;
        cursor: pointer;
    }
    
    .acoes-container {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
    }
    
    .config-file-card {
        background: #f1f8ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .variacoes-container {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block titulo_conteudo %}Configuração de Atributos{% endblock %}

{% block conteudo_principal %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Configure aqui os atributos que deseja extrair das descrições dos produtos.
</div>

<div class="config-file-card">
    <h4>Gerenciar Configurações Salvas</h4>
    <form method="post" action="{{ url_for('carregar_configuracao') }}" class="row g-3">
        <div class="col-md-8">
            <select class="form-select" name="config_file" required>
                <option value="">Selecione uma configuração salva...</option>
                {% for arquivo in config_files %}
                    <option value="{{ arquivo }}">{{ arquivo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">Carregar Configuração</button>
        </div>
    </form>
    
    <form method="post" action="{{ url_for('salvar_configuracao') }}" class="row g-3 mt-2">
        <div class="col-md-8">
            <input type="text" class="form-control" name="nome_arquivo" placeholder="Nome para nova configuração" required>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">Salvar Configuração</button>
        </div>
    </form>
</div>

<div class="config-container">
    <div class="form-container card">
        <h4>{{ 'Editar Atributo' if editar_atributo else 'Adicionar Novo Atributo' }}</h4>
        
        <form id="atributo-form">
            <div class="mb-3">
                <label for="nome" class="form-label">Nome do Atributo</label>
                <input type="text" class="form-control" id="nome" name="nome" required>
                <small class="text-muted">Ex: Voltagem, Cor, Material</small>
            </div>
            
            <div class="mb-3">
                <label for="tipo_retorno" class="form-label">Tipo de Retorno</label>
                <select class="form-select" id="tipo_retorno" name="tipo_retorno" required>
                    <option value="texto">Texto Fixo</option>
                    <option value="valor">Valor Numérico</option>
                    <option value="completo">Descrição Completa</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Variações (Padrões a Buscar)</label>
                
                <div id="variacoes-container">
                    <!-- Variações serão adicionadas aqui via JavaScript -->
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-variacao">
                    <i class="bi bi-plus"></i> Adicionar Variação
                </button>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    {{ 'Atualizar Atributo' if editar_atributo else 'Adicionar Atributo' }}
                </button>
                
                {% if editar_atributo %}
                <button type="button" class="btn btn-outline-secondary" id="cancel-edit">
                    Cancelar Edição
                </button>
                {% endif %}
            </div>
        </form>
    </div>
    
    <div class="atributos-container card">
        <h4>Atributos Configurados</h4>
        
        <div id="atributos-list">
            {% if extrator.atributos %}
                {% for nome, config in extrator.atributos.items() %}
                <div class="atributo-card" data-atributo="{{ nome }}">
                    <div class="atributo-header">
                        <h5>{{ nome }}</h5>
                        <span class="badge-tipo">{{ config.tipo_retorno }}</span>
                    </div>
                    
                    <div class="variacoes-container">
                        {% for variacao in config.variacoes %}
                        <div class="variacao-item">
                            <strong>{{ variacao.descricao }}</strong>
                            <div class="text-muted small">{{ variacao.padroes|join(', ') }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button class="btn-edit" data-atributo="{{ nome }}">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button class="btn-remove" data-atributo="{{ nome }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-warning">
                    Nenhum atributo configurado ainda. Adicione seu primeiro atributo ao lado.
                </div>
            {% endif %}
        </div>
        
        <div class="acoes-container">
            <button class="btn btn-success" id="btn-processar">
                <i class="bi bi-gear"></i> Processar Dados
            </button>
            
            <a href="{{ url_for('exportar') }}" class="btn btn-primary" id="btn-exportar" style="display: none;">
                <i class="bi bi-download"></i> Exportar Resultados
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_adicional %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let atributoEmEdicao = null;
        const form = document.getElementById('atributo-form');
        const variacoesContainer = document.getElementById('variacoes-container');
        const addVariacaoBtn = document.getElementById('add-variacao');
        const atributosList = document.getElementById('atributos-list');
        const btnProcessar = document.getElementById('btn-processar');
        const btnExportar = document.getElementById('btn-exportar');
        
        // Template para nova variação
        function getVariacaoTemplate(index = 0) {
            return `
                <div class="variacao-item mb-3" data-index="${index}">
                    <div class="mb-2">
                        <label class="form-label">Descrição da Variação</label>
                        <input type="text" class="form-control" name="variacoes[${index}][descricao]" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Padrões (separados por vírgula)</label>
                        <input type="text" class="form-control" name="variacoes[${index}][padroes]" required>
                        <small class="text-muted">Ex: 110v,110 volts,110 v</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-variacao">
                        <i class="bi bi-trash"></i> Remover
                    </button>
                    <hr>
                </div>
            `;
        }
        
        // Adicionar nova variação
        addVariacaoBtn.addEventListener('click', function() {
            const index = document.querySelectorAll('.variacao-item').length;
            variacoesContainer.insertAdjacentHTML('beforeend', getVariacaoTemplate(index));
        });
        
        // Remover variação
        variacoesContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-variacao')) {
                e.target.closest('.variacao-item').remove();
                // Reindexar
                document.querySelectorAll('.variacao-item').forEach((item, idx) => {
                    item.setAttribute('data-index', idx);
                });
            }
        });
        
        // Enviar formulário (AJAX)
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                nome: document.getElementById('nome').value,
                tipo_retorno: document.getElementById('tipo_retorno').value,
                variacoes: []
            };
            
            // Coletar variações
            document.querySelectorAll('.variacao-item').forEach(item => {
                formData.variacoes.push({
                    descricao: item.querySelector('input[name$="[descricao]"]').value,
                    padroes: item.querySelector('input[name$="[padroes]"]').value.split(',').map(p => p.trim())
                });
            });
            
            const url = atributoEmEdicao ? 
                `/api/atributos?nome=${encodeURIComponent(atributoEmEdicao)}` : 
                '/api/atributos';
                
            const method = atributoEmEdicao ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocorreu um erro ao salvar o atributo');
            });
        });
        
        // Editar atributo
        atributosList.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.btn-edit');
            const removeBtn = e.target.closest('.btn-remove');
            
            if (editBtn) {
                const nomeAtributo = editBtn.dataset.atributo;
                editarAtributo(nomeAtributo);
            }
            
            if (removeBtn) {
                const nomeAtributo = removeBtn.dataset.atributo;
                removerAtributo(nomeAtributo);
            }
        });
        
        // Cancelar edição
        if (document.getElementById('cancel-edit')) {
            document.getElementById('cancel-edit').addEventListener('click', function() {
                resetForm();
            });
        }
        
        // Processar dados
        btnProcessar.addEventListener('click', function() {
            btnProcessar.disabled = true;
            btnProcessar.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Processando...';
            
            fetch('/processar', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Dados processados com sucesso!');
                    btnExportar.style.display = 'inline-block';
                } else {
                    alert('Erro: ' + (data.error || 'Falha ao processar dados'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocorreu um erro ao processar os dados');
            })
            .finally(() => {
                btnProcessar.disabled = false;
                btnProcessar.innerHTML = '<i class="bi bi-gear"></i> Processar Dados';
            });
        });
        
        // Função para editar atributo
        function editarAtributo(nome) {
            fetch(`/api/atributos?nome=${encodeURIComponent(nome)}`)
                .then(response => response.json())
                .then(data => {
                    if (data[nome]) {
                        atributoEmEdicao = nome;
                        const atributo = data[nome];
                        
                        // Preencher formulário
                        document.getElementById('nome').value = nome;
                        document.getElementById('tipo_retorno').value = atributo.tipo_retorno;
                        
                        // Limpar variações
                        variacoesContainer.innerHTML = '';
                        
                        // Adicionar variações
                        atributo.variacoes.forEach((variacao, index) => {
                            const variacaoHtml = getVariacaoTemplate(index);
                            variacoesContainer.insertAdjacentHTML('beforeend', variacaoHtml);
                            
                            // Preencher valores
                            const item = document.querySelector(`.variacao-item[data-index="${index}"]`);
                            item.querySelector('input[name$="[descricao]"]').value = variacao.descricao;
                            item.querySelector('input[name$="[padroes]"]').value = variacao.padroes.join(', ');
                        });
                        
                        // Rolar para o formulário
                        document.querySelector('.form-container').scrollIntoView({
                            behavior: 'smooth'
                        });
                        
                        // Alterar texto do botão
                        form.querySelector('button[type="submit"]').textContent = 'Atualizar Atributo';
                    }
                });
        }
        
        // Função para remover atributo
        function removerAtributo(nome) {
            if (confirm(`Tem certeza que deseja remover o atributo "${nome}"?`)) {
                fetch(`/api/atributos?nome=${encodeURIComponent(nome)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Erro ao remover atributo');
                    }
                });
            }
        }
        
        // Função para resetar formulário
        function resetForm() {
            form.reset();
            variacoesContainer.innerHTML = '';
            atributoEmEdicao = null;
            form.querySelector('button[type="submit"]').textContent = 'Adicionar Atributo';
        }
    });
</script>
{% endblock %}

