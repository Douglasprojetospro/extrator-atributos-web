{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h3>üîß Configura√ß√£o de Atributos</h3>

    <form method="POST" action="/adicionar-variacao">
        <div class="mb-3">
            <label for="nome" class="form-label">Nome do Atributo</label>
            <input type="text" class="form-control" name="nome" id="nome" required value="{{ atributo_em_edicao.nome if atributo_em_edicao }}">
        </div>

        <h5>Varia√ß√µes</h5>
        <div id="variacoes-container">
            {% for i, variacao in enumerate(variacoes or [{}]) %}
            <div class="card p-3 mb-2 variacao-item">
                <div class="mb-2">
                    <label class="form-label">Descri√ß√£o da Varia√ß√£o</label>
                    <input type="text" class="form-control" name="variacoes[{{ i }}][descricao]" value="{{ variacao.descricao }}" required>
                </div>
                <div>
                    <label class="form-label">Padr√µes (um por linha)</label>
                    <textarea class="form-control" name="variacoes[{{ i }}][padroes]" rows="3">{{ variacao.padroes | join('\n') }}</textarea>
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-success mt-2">Salvar Varia√ß√µes</button>
    </form>

    {% if atributo_em_edicao %}
    <form method="POST" action="/salvar-prioridade" class="mt-4">
        <h5>Prioridade das Varia√ß√µes</h5>
        <p>Arraste para ordenar:</p>
        <ul id="lista-prioridade" class="list-group">
            {% for v in atributo_em_edicao.variacoes %}
            <li class="list-group-item">{{ v.descricao }}</li>
            {% endfor %}
        </ul>
        <input type="hidden" name="ordem_prioridade" id="ordem_prioridade">
        <button type="submit" class="btn btn-primary mt-3">Salvar Configura√ß√£o</button>
    </form>
    {% endif %}

    {% if atributos %}
    <hr>
    <h4>Atributos Configurados</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Varia√ß√µes</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for nome, config in atributos.items() %}
            <tr>
                <td>{{ nome }}</td>
                <td>{{ config.variacoes | map(attribute='descricao') | join(', ') }}</td>
                <td>
                    <a href="/editar/{{ nome }}" class="btn btn-sm btn-warning">Editar</a>
                    <a href="/excluir/{{ nome }}" class="btn btn-sm btn-danger">Excluir</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="/exportar-configuracoes" class="btn btn-outline-secondary">Exportar Configura√ß√µes</a>
    <form method="POST" action="/importar-configuracoes" enctype="multipart/form-data" class="d-inline-block">
        <input type="file" name="arquivo" class="form-control d-inline w-auto" required>
        <button type="submit" class="btn btn-outline-secondary">Importar</button>
    </form>
    {% endif %}
</div>

<script>
    // Drag and drop para ordenar prioridades
    document.addEventListener('DOMContentLoaded', () => {
        const lista = document.getElementById('lista-prioridade');
        if (lista) {
            new Sortable(lista, {
                animation: 150,
                onEnd: () => {
                    const ordem = Array.from(lista.children).map(li => li.textContent.trim());
                    document.getElementById('ordem_prioridade').value = ordem.join(',');
                }
            });
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}

